use std::iter::FromIterator;
use std::{cmp, collections::HashMap};

static _SAMPLE_INPUT: &str = r#"Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###..."#;

static _INPUT: &str = r#"Tile 2477:
....#...#.
#..##...#.
...#.....#
..#...#.#.
#.#......#
.#.#######
..#.#...#.
.#.....#..
#..#......
.###.####.

Tile 2609:
.##...####
...#.##.##
...#......
...#....#.
.##....#.#
..........
....##....
#....#..##
..######..
.##.##.#.#

Tile 3461:
##.##..##.
.##....#..
...#....#.
#.#.#...#.
........#.
.#.#..#..#
..#.......
#..##.....
...#.....#
.#..####..

Tile 1753:
#...#####.
#...#.#..#
#.#....#..
#.......#.
.....###.#
.......#..
.....#....
..##...#.#
#......#..
#.#..##.#.

Tile 1259:
...##...##
#.##.#.###
#.#.....#.
###..#...#
...#......
##.#..#...
#........#
..##.####.
..##....##
....##.#..

Tile 3181:
.#######.#
#...#....#
#.....#..#
#.#.#...#.
.#..#.....
....#.....
#.......#.
#.........
..#..###..
.##..#...#

Tile 1123:
#..####.#.
#...#.....
#.........
....#.#..#
..........
..##...#.#
#..#......
#...#.#..#
.##.##....
#####.####

Tile 2699:
....###.#.
#.#......#
#..##....#
..#.....#.
#.#......#
....#...##
.##...#.##
..........
#.#...#...
##.#...#.#

Tile 2897:
#.#.##..##
#....#..##
....#...#.
..........
#..#..#..#
#.........
##.......#
##.##....#
........##
#.##.#...#

Tile 2531:
.##....#.#
#...#..###
...#....#.
#.......##
#.......##
......#...
#.#.......
#......#.#
#..#.#...#
...#.##..#

Tile 3917:
.#.#.#..#.
##..#....#
....#....#
#.##..#..#
#...#....#
.....#.#.#
.....#.#.#
##..#.#.##
.....#...#
.##.###.##

Tile 1193:
#.###...##
#..##.####
#.#......#
...###....
.#.#..#...
##...#...#
##.......#
..........
...#......
##..#.#.#.

Tile 2011:
####.#..#.
..#...#..#
#.....#...
..........
..#.#.....
#........#
.....#...#
#........#
.........#
.###..##..

Tile 3209:
######.##.
......#..#
....#...##
..##..#...
...#.....#
....##...#
#.......##
..#..#....
....#.....
.#..#.####

Tile 3659:
.#...##..#
........#.
#...#.....
#........#
....##...#
#..#....#.
.#..#..#..
#....#.#.#
.........#
###.#.#..#

Tile 3623:
.##..##...
..#.....##
#.........
.#.#.....#
...#.....#
.......##.
#.......#.
...#.#...#
#......#.#
..#####...

Tile 3049:
####.#####
..#.....#.
.#..#...#.
.#..##...#
#........#
#.#.......
#.##......
.#....#..#
##........
.####..#.#

Tile 3361:
....#.#..#
...#...###
#....#...#
#....##..#
###.#.##.#
...#.#...#
##.#......
#....##..#
.#.....###
.##.#.....

Tile 2861:
.#.##.#..#
#..#...#..
....#....#
..#.....##
...#.....#
#..##.....
##.......#
.....#...#
.#..#..#..
..#.#.#.#.

Tile 3797:
.......##.
#....#....
#..#...#..
#..#..###.
#.#...#..#
.#...#...#
...##.....
.#.....#..
..#.....#.
#.##.##..#

Tile 3593:
.#.....###
..##....#.
..##..#...
#...#...##
.#.....#.#
#.#...#..#
#....#...#
#.....#..#
###..#.###
.##..##.#.

Tile 2161:
.#.##....#
#....#....
....#....#
####...##.
#..#..##.#
#.........
..#.#...##
#.....#..#
.........#
#.###.#...

Tile 3769:
#..###....
##........
#.#....#..
....#.....
#..##.#...
#....#.#..
#........#
......#.#.
##.....#.#
.#....#..#

Tile 3467:
..#.#.####
##.......#
.##..#....
...###...#
.##.###..#
....###..#
.....#....
##.......#
#....##...
#.#..#..#.

Tile 2503:
#..###.###
.#.....#.#
#......#.#
...#.##...
###.#....#
....#....#
#.#...##..
#.......#.
#.#.#....#
....######

Tile 3389:
#..###..##
..........
.......##.
..........
..........
..........
#.....###.
.........#
##.#.##..#
.##.##.#..

Tile 3919:
..#..#.#..
##....##.#
##..#...#.
#.......##
#.#.#.#...
##..#.#..#
......##.#
...###...#
#...#.....
..#.#.#...

Tile 2663:
#.#...####
.......#.#
.#.....#..
#.....#.##
.#..#.....
..##..#..#
#......##.
...#...#..
#.##...#.#
...##.....

Tile 3253:
.#####..#.
.......#.#
#..#...##.
....#.....
.........#
...#.#....
##........
........#.
#....#...#
.####.##.#

Tile 3329:
......####
.......#.#
..##......
#....#...#
.....##...
.....#..##
.....#....
.#.#.#....
.#.......#
#.##......

Tile 2393:
.#...#...#
....#.....
....#...##
#.#..##.#.
...#.#...#
.....#..#.
.##..##..#
##..#..#..
.#........
.##.#.#.#.

Tile 2339:
##....##.#
..#......#
##.....##.
.........#
...##....#
#....#.##.
#.#.....##
.#..#.##..
##.###..#.
######..#.

Tile 1097:
###.##.#.#
.#.#.....#
...#.#....
##...##...
.#....##..
#....##.##
....##....
#.#......#
#.#..#...#
#.####....

Tile 2423:
#....#.#..
#.....#...
#.........
#...#.....
..###.#..#
#...##....
#.........
#..#.....#
...#..#...
#..##.#...

Tile 3067:
.#####.#.#
###..#.#..
..........
#........#
..##.....#
#......#..
.#..#.#...
##...#..##
....#.....
...#.##.##

Tile 3541:
#.#.##.###
..........
..#.#...##
#..##.#..#
.........#
#.....#...
#..#......
#.##......
.#...#.#.#
.#####..##

Tile 3559:
##.#.#.#..
#....#..#.
##...#....
.....#..##
#.........
..#...#...
.#...#...#
#...#..#..
....#....#
.....###.#

Tile 2797:
.....#..##
#.#....#..
##...#....
#.........
...#......
...#...#..
#.......#.
..........
....#....#
#......###

Tile 2803:
##....#.##
..#.......
.###.#....
#.#.#.....
.........#
#..#...##.
#.#.##..#.
.##...##.#
#.#......#
.###.#.#..

Tile 2297:
.#.#.##.#.
#.##.....#
#.##....#.
.......#.#
#..#......
.##.#..#..
..........
..#.##..##
#.......##
.###.##.#.

Tile 3511:
...#.#....
#.....#..#
.......#..
..##.#.##.
#.#....#..
#.#.#.#...
.#........
#.#.....##
.#....#..#
####..#.#.

Tile 2083:
#####.....
##..#.#..#
....#....#
...#......
##....##.#
#....#.#..
##.....##.
.......#.#
##........
###..##.##

Tile 1567:
####.###.#
....#....#
.#..##.#..
#........#
...#.#...#
#.#..##.##
##...#....
##........
#........#
#...#.#..#

Tile 2767:
..###.##..
#..#..#..#
.###.....#
#..#......
......####
....#..#..
#.....##.#
#.#...#..#
.#....##..
.#..####..

Tile 2081:
.#.##.####
#...#.#...
#...#.##..
..#.....##
...##....#
...#......
...#.#....
..........
..........
.####..###

Tile 1697:
...#...###
#..#..#...
.....#..#.
#........#
#..#......
#.......#.
#....#....
#...#.##..
#....#..##
#.##..#...

Tile 3433:
.###...##.
#........#
.#...###.#
##.......#
.......#.#
.....##.#.
#..#..#...
.......#..
.....###..
.....#.#.#

Tile 1543:
#.###.##..
.#...#....
##.....###
#..####.#.
#...#.....
.#......##
#.........
....#.#.##
##.......#
.#........

Tile 2389:
#....#####
.##......#
###.#....#
..#.......
...#.#...#
.......#.#
#....#....
...#...#..
#.#.......
.##..###.#

Tile 2347:
#....##..#
#......###
........#.
.#...#.#..
#........#
.....##...
#........#
#.....#...
##....#..#
##...#.###

Tile 1877:
.#.#.##.#.
#..##...##
#...#...##
##.#......
........##
....#.#..#
#..##.....
....#...##
#.#.#.#..#
.#..#..#.#

Tile 2927:
.#.#...###
#...#.....
..#.......
##...#...#
#..#...#.#
..........
#.#..##...
#.#.......
.....#...#
......###.

Tile 1483:
..#.#...#.
###.##....
#..##.....
.#...##..#
...#.##.##
#.#..#.#.#
..#..#....
#..#......
#........#
....##.##.

Tile 1493:
#.#....##.
..#....#..
..........
.....#...#
.....##..#
...#..#..#
.........#
#.#.#....#
.#.....#.#
..###...#.

Tile 2621:
#..##.#..#
..##.#...#
..........
#......#..
.###..#...
###.#....#
##..#....#
##..#....#
.........#
##.#......

Tile 3167:
..#.###..#
###.#....#
#........#
..##......
###.#..#..
##...#...#
..........
##.#...#.#
.###.....#
####.##...

Tile 3701:
.#.#...##.
......#...
#.........
......#..#
....#....#
....#.#..#
#..##....#
#.....#..#
#...###..#
..##.#....

Tile 1663:
##.#..##..
#.....#...
....###...
#....##..#
....#...#.
#..####..#
...##.....
.##..#....
#.#....#..
#..##.#.##

Tile 1879:
.#....#...
....###.#.
#....#...#
#..##.....
#......#.#
.....#....
#.........
.........#
.#........
##.#...#.#

Tile 1021:
..#.......
.#......##
.##...#...
.##.......
##.#...#.#
#..#.....#
.#........
...###...#
###.......
....#..###

Tile 3767:
..#.#....#
.....#.#..
..#..#....
##..##....
.#.......#
...#......
......##.#
#.......##
#........#
.######.##

Tile 1847:
....####.#
##.#...#..
##.#.##..#
..####...#
#........#
#.........
#...#....#
##.#.#..##
..##.....#
##.##..#..

Tile 3691:
#.##..#...
...#....#.
#...#.....
.....#....
......#.#.
.#........
.#........
.........#
..........
#.....##.#

Tile 2351:
###..###.#
#....##...
#......#..
###......#
#...##.###
##...##..#
..#.......
.#....##..
...#......
.###.##.##

Tile 2753:
#.####..#.
#.......#.
..#.#.....
.....#....
#..#..#...
#......#..
..#...####
#.......##
....#...#.
....#.#..#

Tile 2141:
....##...#
..#..#....
..........
..........
###....#..
...##.#...
##.#.....#
.#....#..#
#.#....#..
.#########

Tile 1901:
.....#.#.#
#......#..
#...#...#.
...#....##
#..#.#....
........#.
.......#.#
#.....##..
#...#.#.##
.#....##.#

Tile 3137:
.##...#...
.#.....###
#.#.#..#.#
#.###.#...
#..##...#.
.........#
#.#..###.#
#......#.#
#......#..
.#..#.#...

Tile 3407:
.#.###.###
...#......
..#.##....
.#.....#..
....#.#..#
...#...#..
....#..#..
##...#....
.#....###.
##.###.##.

Tile 1013:
##.#.###..
#...#.##.#
#........#
#..#.....#
..........
.........#
...#......
.#.....#.#
.......#..
.#...####.

Tile 1049:
...#....##
#.........
#.....#..#
#..#....##
.##...#...
......#..#
##..#.#...
#.##....##
....#....#
#####.#.#.

Tile 2549:
#.#..###.#
#..#......
...#....#.
.....#...#
#.##.....#
###..#.#..
...##.....
##...#....
#......#..
..##.####.

Tile 2843:
.##.###...
....#....#
#.......##
#........#
.......#.#
#.......##
#.#..#...#
#...#.....
#...#....#
.....###..

Tile 1889:
##.##..#..
...#....##
#........#
#......#..
##..#.#.##
......#...
..#.......
..#......#
#.#..#....
..#......#

Tile 2887:
.####.##.#
#..#......
#.........
#....#....
#....#...#
.....#...#
#.#.#.##.#
.#........
##.#.#....
...#.#.##.

Tile 1579:
..######.#
..........
#.##..#...
####..#..#
#........#
...##....#
..#.......
..........
..........
....#....#

Tile 3079:
##.#....#.
###.....##
...##...##
#....#..#.
....###...
...####...
...#.#....
.#.#.#..##
.....#..#.
##...#..#.

Tile 1297:
.####.###.
##...#...#
.....#..#.
#...#.....
###......#
.#..#....#
#....#..##
.##...#...
#....#....
###.####.#

Tile 1783:
...#.#.#..
#...#.....
..#..#...#
......##..
###..#.##.
.#...###..
#.........
#........#
..#......#
..#..##.#.

Tile 1609:
.#.##..#.#
.#.#....#.
#.##......
..#......#
.##.#.#.##
..#.......
###......#
...#...#.#
...###....
..#.....#.

Tile 3793:
##.#.##.#.
...#......
..##....#.
#...#...##
.......#.#
.....#.#..
....#....#
#.##.....#
#..#.##..#
###.##..#.

Tile 1069:
..#.#...#.
..#.#....#
##..#.#..#
.....#....
.....##.#.
.#.##.#...
#.......##
##........
....#.#..#
.#..###.##

Tile 1229:
..#.#####.
.......#..
....#.#.##
.#........
#...#..##.
##....#.#.
#........#
..........
.......#..
##.##....#

Tile 1163:
....#.#.#.
#..#.#...#
.........#
#........#
#....#....
..#.#....#
#...#....#
#....##...
#..#......
#..##.#.##

Tile 3847:
#...#.####
.........#
......#...
#..#..#.##
.....##...
#........#
#...#....#
#.#....#.#
#...#....#
#....#####

Tile 3823:
#..##.....
..#..#.#..
#.........
#.#.##....
#....#...#
#..#......
#...#.....
..........
..........
...#..#..#

Tile 3583:
#...#.###.
##......##
.#........
..#.......
....##..#.
.........#
##........
###.#...#.
.#........
#.#..####.

Tile 2399:
#..##..#..
##......#.
#.#.#.#...
...##.#..#
......#..#
#.#.###...
.#.....#.#
###..#....
.#.#..#..#
###..##...

Tile 3347:
.#.#....#.
..#.#....#
..........
#.##.#.#.#
....#.....
.#....#...
#........#
#....#...#
#..####..#
..#####.#.

Tile 1307:
#...#...#.
....#....#
.#.......#
.......#..
#.#.#...##
#..#.#.#.#
##.#.#.##.
....##....
#.....#.##
.#..#...#.

Tile 2099:
.##...####
...#.##.##
.....##...
#...#.#...
.#......#.
#........#
...#..####
....##..#.
.....#....
..#.###...

Tile 3109:
#..#.###.#
....#.#.##
....##..##
#.#...#...
#.......#.
#..#......
.#.....#.#
#.##....#.
..#.......
....##..#.

Tile 1787:
#...#...##
#.........
###.......
...#..##..
#.#.##....
##....#..#
##........
#..##.##.#
..#....###
....#..#.#

Tile 3019:
#.##...#.#
#...##...#
...#..#.#.
......##.#
.#..####..
#.#.....#.
#......#..
#.........
..........
...###...#

Tile 2857:
.#...##.#.
#.....#..#
#.....##..
#......#.#
...#..#...
...#.....#
#...###..#
.....##..#
...#...#..
##.#....##

Tile 3083:
#..##..##.
.#....#.##
#..#....##
..........
#...#..#.#
.........#
.#........
##.......#
..........
.##...##..

Tile 1583:
#.###.....
....##.#..
..........
#.....#.##
#........#
##........
#......#..
.........#
#.#.#.....
.#.####...

Tile 2693:
...####.#.
.........#
#.........
....#.##.#
#.......#.
.........#
...#......
.......#.#
..#.#....#
.#..#..#..

Tile 1019:
.#.#......
#......#.#
.#...#.#.#
#.#.......
......#.#.
#........#
##..#..#.#
#.#####.#.
.....#...#
.......###

Tile 1031:
#..#......
.........#
#.....#..#
....#.#.#.
..#......#
#...#....#
...#..##..
.#..#...#.
.......##.
.#.#..#...

Tile 3119:
...#.#..##
#.##......
....#.#.##
##..#.#..#
........#.
#...#.#...
...#.....#
..##....##
#..#...#.#
###...#.#.

Tile 1811:
.####..###
#......#.#
#.........
.......#..
..#.##...#
........##
#....#....
#..#.#.#.#
#..#...#..
..####.###

Tile 2473:
.#....####
##.....#..
....#..###
#..#....#.
###...##..
..........
...#.#...#
........##
##......##
....#.....

Tile 1373:
..#..#....
#...####.#
....#....#
....###...
...#.##.#.
#..#.#...#
...#..#..#
#..#.#...#
##.###....
.#.#####..

Tile 3803:
#...##.#.#
#.#..#..#.
.........#
..#......#
.#.#..#..#
..........
##..#.###.
..#####.##
....##...#
.#.##.##..

Tile 1291:
#..#.....#
#..#..##.#
#.#......#
....#...#.
##.######.
#........#
#....#....
#.....#...
#####.....
#######.#.

Tile 1489:
#...#...##
#..#....#.
....##....
....#.....
#........#
#.#......#
##......##
#.#.#.....
.....#.#.#
#.#.###.##

Tile 2633:
.#..##.#..
..#.#...##
#.........
#..#......
#..#.....#
#.........
#....#..##
#.###.....
#.##.#..#.
...#..###.

Tile 2441:
#.#..###..
...#.....#
#...##...#
#.##...#..
#.....####
#..#....#.
...#......
#.........
#.#.......
....###.#.

Tile 2689:
##..#.....
.#........
..........
#.#.......
....#...##
..........
#.....#...
#...#.....
#.....#...
####...#..

Tile 1559:
#..###..#.
#.......##
......#...
.##..###..
#..#..##.#
..#...##.#
#.........
#..#.#...#
##.....###
.#.....#..

Tile 1973:
.###......
#......#.#
.#........
...#.....#
..#....#..
....##....
..........
......#..#
.....#....
#..#.#...#

Tile 2113:
#.##.#.#.#
..#..##...
#...#.#...
.#.#......
.#..###..#
........#.
#........#
#.#.#..#..
..........
##.##...#.

Tile 2903:
..#...##.#
#...#.....
#..###.###
...#.#...#
#...#...##
#..#..#..#
#........#
##.###...#
#.#..#...#
.#....#...

Tile 2003:
.##.#..#..
...##...##
.#.....#.#
##..##...#
...#.#.#.#
.........#
#...#.##..
.....##..#
#.#..#....
###...##.#

Tile 2273:
...##.#...
.##....##.
#......##.
#.......##
....##...#
......#...
..#.#.....
.#.#..##.#
#........#
..#.#..#..

Tile 2111:
#.#..#..##
#...##...#
..........
###.....##
##......#.
..........
#....#####
#...#.#.#.
....#..#.#
#...#.###.

Tile 2203:
.#####.##.
#...##...#
#..#...#..
#.###...##
#....##.##
#....#..##
....#.....
...#....##
#.#...#...
#.#.#..###

Tile 2153:
#.###..#..
..........
...#.....#
..###..##.
...#.....#
....#....#
#...#....#
#.........
#..##...#.
###.##..#.

Tile 2963:
.#.#.####.
#....#....
.........#
#........#
#..#.....#
#.#......#
......#.##
.....#....
#...###...
.####..##.

Tile 3491:
...##.####
#.#.....##
.#..#..##.
#........#
.#...#...#
....#...#.
#.#......#
.........#
....#...#.
##.##..#.#

Tile 2087:
#.#......#
#..##..#..
#..#......
#...##...#
#......#.#
#.#...#...
......#..#
#...#....#
#....#....
##.#..#..#

Tile 2063:
..##...##.
....#....#
#..#...#.#
#........#
##......##
..#..##..#
......#.#.
#.#.......
..##.#....
.#######..

Tile 3851:
.#........
#.#.....#.
.........#
......#...
.#....#..#
...##.....
#........#
#.......#.
#.#......#
##.####..#

Tile 1117:
##.......#
..#......#
##.......#
##........
...####.#.
..##.##..#
...#....#.
##.#......
.........#
.#.##....#

Tile 3967:
...#.##...
#..#..##.#
#.....##.#
#......#.#
#.......#.
##........
#..#.#.#..
....#.#.##
.#.#..#...
###.##.##.

Tile 2879:
###..#..##
.....#.#..
...##.....
#.###.#..#
.........#
.#.#.....#
#.#.##....
#..##....#
##.......#
#.##.#####

Tile 2851:
###..#.##.
.###...##.
...##.#.#.
#........#
#........#
.#.#......
##.#......
..###.....
.#...#..#.
#.####..#.

Tile 3529:
.#.#.#####
..........
...#..#..#
...#.....#
#.#......#
#....####.
.....#...#
#.##......
.#...#...#
#.#..###.#

Tile 3307:
#.#..###..
....#..###
#.##....##
#..#.##.#.
#.#...##.#
.#....#...
...#.#...#
...#...#.#
##......#.
...#......

Tile 3739:
#.###.#...
.#.#..##.#
..#..#..##
#...##...#
#...#..#..
.........#
.....#...#
##....#...
.#......##
...#..#..#

Tile 2617:
##.###.#..
..#......#
..#....#..
.#....#...
.#..#.....
...#..##..
...#.....#
#.......#.
#.#..#...#
..###..#..

Tile 2053:
.#....#.##
#...#.....
.........#
#........#
...#..##..
###..#.###
........#.
.....#####
##....#...
.###.##..#

Tile 2447:
.#.....##.
......##.#
#......#..
.#......#.
.#.##.#..#
#.#....###
#.#......#
##........
.#.......#
#.#.#....#

Tile 1999:
.#...###..
#...#..#..
#.#.......
...#....##
#.#.......
##...###..
#......#..
...###.#..
####...##.
.....#..#.

Tile 1009:
...#####.#
....##...#
...#.#....
#..#.#.#.#
#...##....
........##
#.....#..#
.#..##.#.#
#..#...#..
...#.#..##

Tile 2267:
.#.#..##..
.#.......#
#........#
.#.......#
#..#...#.#
#..#..#..#
.####.....
..#......#
##.....#..
##...####.

Tile 2131:
###.#..##.
.#....#...
...##.####
..#.#..#..
#.#....#.#
...###.#..
#.....#..#
..#...####
##.#..#..#
#..###..##

Tile 2251:
###.......
....#.#..#
.....#....
...#..#...
.........#
##..#.....
##.......#
.#.....#.#
#.#.....#.
#...#.....

Tile 1109:
..##....#.
.#...#..##
#.........
#..##....#
...#...#..
#.##......
.#...#.#..
...#..##..
.#...##...
.##.###.#.

Tile 3343:
..###.#.##
#....#.###
....#....#
.........#
..##....#.
#.....##..
#..#......
.........#
.###...#..
.#..######

Tile 2383:
.#.####.##
#.....#..#
#......#.#
##.....##.
#......###
....#...#.
....#...#.
##....#..#
##..###..#
.####.#...

Tile 2281:
..#...##..
#..#...#.#
.#........
.#.#....##
..##.#.#..
..#...#...
###.#..#.#
#...##.#.#
...##.#..#
#..#.....#

Tile 3191:
.###.###.#
..#.......
.##....###
...#..#...
..#......#
#...#.....
#........#
#....#..##
#.#.#...#.
#.......#."#;

static _SAMPLE_MAP: &str = ".#.#..#.##...#.##..#####
###....#.#....#..#......
##.##.###.#.#..######...
###.#####...#.#####.#..#
##.#....#.##.####...#.##
...########.#....#####.#
....#..#...##..#.#.###..
.####...#..#.....#......
#..#.##..#..###.#.##....
#.####..#.####.#.#.###..
###.#.#...#.######.#..##
#.####....##..########.#
##..##.#...#...#.#.#.#..
...#..#..#.#.##..###.###
.#.#....#.##.#...###.##.
###.#...#..#.##.######..
.#.#.###.##.##.#..#.##..
.####.###.#...###.#..#.#
..#.#..#..#.#.#.####.###
#..####...#.#.#.###.###.
#####..#####...###....##
#.##..#..#...#..####...#
.#.###..##..##..####.##.
...###...##...#...#..###";

static _MAP: &str = "....#....#.#....#........#...#...#..#..#.............#..........#.......#...#.#...#.#....##....#
#..........##....#..#....................#.#.....#......#........##..#................#.........
..........#.#.##.#...##...###.#..#..................###..##.......##.........#....##..........#.
.#........#.....................#.#..#....#.#.......#........#...###.........#..#..#........#...
#........#.#.#..#.##....#.#...................#.#.#............#.....#.................#........
...#..#............#..#..#...#..#..#.###.#..#........#.....##..#..#..#..#..#....#.....#........#
....#...#..#.......#.....#..#....#####.##....###.#.........#..#.##...###....###.##.#........#...
....#.........#....#......#.#......##.........##.........#.#....#..#....#..#.##.....#.........##
..#......#.#..#.....#....#.#..#...#..............##...#......#.....#.......#.......#..#...##.#.#
.##..#............#...##.......#.#...##.#..#.......#............#............#.##...............
.##.#......##.#......#...##.#......#..........#.....#......#....#.##.#..#....#.......#..###.....
....#......#....####..#.........#...........#..#......##.###.#..#.###.###...#..#.##..#..........
.............#..#..#..#..##.#.....#..#.#....#.....###.#....##...###....###...#......#..#........
.##.........#....##....##....###.....#....#........#...............######..#......#....#........
........................#.....#....#.......#..........#...#..................#...#....#.##......
......................#...#..............#.........#......#..#.........#..............#.........
...#....#......##............#..#.......#...#.#.#..#.#.#...#.#.....#......#...............#..#.#
.#.#..#...#....#.....#..............#...#..#.............#.......#.#..##.......#........###...#.
#...#.#....#.....####..#.......#..................#...........#.....#.###.#..#..#..##.....#.....
#..##...............#.#....#...#...##.......#...##........#......#.#....##..#####.#####..#.###..
...#.....#..#....##.#.....#..#.##....#........#.....#...#........#.................###...#....#.
.......#...##.....#....#...###...#..#..#..#..#..#..#....#...................#..#.....#...#..#.#.
..#..#..#..#..#..#..#.#.......#..#.#....##....##...####.#....#.....#.#..............#.#.###.##..
..#.#.#..##..#.##....######.##................#......#..##..#...##....#.##.#..#..#..#.##..#....#
....#.#...........#...#.......#.#.##..........#.#..#.....#....#...#.......#..#.##....##...####..
#.........#.....#....#..#.............###.........#.....................#.#.#.....#..##.....###.
.##...#.#...#.#.....#......#.#..##.......#.........##.......#.....#......#.#.#..#...#...##.....#
....#...........#..#....#............#...##...#........#....##......#..........#.#.....##.......
....#.##.##..#..#.##.........##..##.##.#..#..#.....#......#..#....#.#...#.........#...#.#.##....
..##.#..##...####...###..##..#....###...###...###...................##...#.........#............
.#..........#....#...#...#....#....#......#....#.....###.#.#......#......##.......#.............
.#.....#...#.......##...#...........#...##....#....#....#.....#...###....##..#..##.#..####...#..
......................#........#..#.................#..#.#..#...#.#....###....###...##....###...
.......#.....#.#.......#........#.#.##.##....#...#.#..........#....#..........##....#..#...#....
.....#..#....#...##.#.#...#...........#...##.#.#.##..##.#....#...#.###.........#........#.#.....
..#....#..##.##.##.#..#.#.#........#..#.......#.#.............#......#.....##.........#.......#.
.##..##.#.####...##...####..#.................#...#..#...###...##.#....#.....#...............#..
.#.#.##........#....#...#.......#.#.........#.....###....#......##.......#.#......##..#.........
..#..#.........#.#.........#................##..#..#..#..#.###...##.#...#.#..##.#...............
#..#..........#..#.#....#.........##.#.....##...###....###...###.......#..........#........#....
.......#.....#......#.............#...#.##.....#...#........###..#.......##....#.....#........##
.....#..#...#.....#.........#..#..........##.......###.#.......#.#.#...##...#..#.............#..
................#...#.#..............#.#.....#.##..#.###...#..........#.#........#..#...#......#
.#..#....#..........#..#....#....#.#.......#.#..................#.#.......#.#.#...#..........#..
...............#....#.....#.....#..#..#..##.#.##....#....#...#............#.#..#....#..#..###..#
#.#........##...#.............##....##....##....###.....##.#..#..#..#..#.##..................#..
........#........................#...#.....#.....#....#...#..#.##.#####....###..##...........#..
....#....#.......###..#.................##...#...#.....#...#...#...#........#....#....#.........
#......#............##...#............###...#...#........#.##......#.#.....#....#..#............
#...................#.#..#.....#.#......#...............#..#...#....#....#..#...#..#.#.#........
...#.#.....##..#......#......#...#....#.###...#.#........#..#.....#..#.......##....#.#...#......
.............#...#...#...................#........#...#.................##..#.##..####..#.....#.
.##...##.....##...#..#............#####...#..#....#..#...#.#....#..#....#...###...###....####..#
#....#..##.#.##..#..#........#.....#.......#....####............#...............#..#.....##.....
##..#....##....####..###........#...........#.#..#..............#.....#.........#...##..#.#..#..
.#.....#.........#....#..##.#.......#...#.......#.....#...#.#....#.....#.#......#.....##...##...
....#...#..#..##.#...#......#.##..#..#..#..#...#...............#.......#.#.....#...#......##....
#......#............#......#....##...###....###...#......#....#...#.##.#.....#..........#.....#.
...#.........#..#.....#...........#.#........#.#...#........#......#...#.....#............#.....
...#.....#..##.......#...##....#.............#.##.........#.##...#....#..#..#.##..#..##..#.#..#.
.............#.#....##.......##....#................###..#.#.....#.#.#..#.##....##..#.###..#....
....##...#...#.........#..#.........#.##........#..#............#...#....#...#.........###.#....
..............#....#................#..##.#.##..#..##...#.#......#........##........####......#.
.#.....#.#.#.##..#..#..####...#..#.#....##...###...####..#.....#..#...##.#......#....#......#...
....#..#..##...##....##.#..###.#....#.#............#.#.#.#..#..##..#.....#....#.............#...
#...#...#.....#.#..#.....##.#..#..#....#.#..#......##..#......#...........#....#........#.......
....#..##..##......#....#.....#..................#...#..#.....#....#.........#.#......#....#.###
..........#.#.#......#.###.#....#..#..#....#...........#.#...#.#..#.......#.##..#..#..#..#.#.##.
.#...#..........#.....#.....##......#.......#..#..#...........#..#.......#....##....##....###.#.
#...#......#.##......#..................##...#..#.....#.#..#....#...............#......#..##....
...#..#.....##..#...#...##.....#......#.#...##.#.##....#............................#...##......
...#.....#..#.........#.......#.#..#..####.##..#.#..................##.....#..#..........#......
.#.##..........###......###...##....##...######.####.#.#....####..##..#.#....#.....#.#..##......
............#..#.........#...#.......#..#..#.....##....#..#.......#......#...##....#.##.#.#.....
#.#.........##........#....................##......##.#....#.......##.......##...#.....#....#.##
........#.#...##..#......#..#...##.....#..............#...............#....#...#..##......#.#...
.......#.......#.##.........#.....#....#.#....##......#.######.#.#...#....#.......#.............
.#........#...#......#...........##.....#....#...#......#...#........#....#..##...#.#...........
............#...#...##..........#.#..........#.....#..........#....#....#...#...................
....#.#..........##...##.#..#..#.##.##..#.##.#..#........##..#......#....#.#..............#....#
...........#.##..#...#....##...###....###.##.#.......#.#..#.##..#..#.##....#..........#.##.....#
.........#.........#......#......#.....#..##......###.#..#.##....##....###..#.#.................
...#.##...#..#......##...#...#.#.#.#......#.#.....#......#..#.####......#.##..#.......#....#....
.......#..####..#..#..#..#.......#...#.##......#....#.....#...#.....#...#..#..#..#.##...#.......
.........#....##....###.#.######..................#......#.#.##.#.....#................#.#....#.
..#.........#..........#.#.#...###.##..####..#..#...#..##....#.#....##....#.........#......#..#.
......#...#..#....#.##..#.....#.##...####..##....###...........#..................#.#.#.........
.#.#....###........#.#.#..#........#.#.....#......#...#..#...#...............##...#...#......##.
..#.....#..#.#..#......#...#...#.##.....#....#.......##..#.#..#.#.#.....##........##..#......#..
.#.##.##.#####..#..###..#..#.......##........#........#........##...##..#...#..##...#.#.....#.#.
#..#....##....##...####.....#..........#........#......#...#.....#.#..#..##..#...#...#..#.......
...#.#.....#...#.#...#........##....#..#........#.##.#..#..#..####..........#....#..#....##...#.
#..............#............#..#..#..#..#.##.#...#....##....##..#.####........#.....#....#.....#
......#....#.....#..#...#..#....##....###...###..#......#..##.#...##....#.#.#....#.#.#..........
.#....#.......#....#.#....#...##.#....#......#..#...................#.....#.....##...#.........#
........#..#....#....#.....#....................#.........#.#......#............#.......#....#..";

static _SNAKE: &str = "                  # 
#    ##    ##    ###
 #  #  #  #  #  #   ";

#[derive(Clone)]
struct Tile {
    id: usize,
    data: Vec<Vec<char>>,
}

impl Tile {
    fn horizontal_flip(&self) -> Tile {
        let data = self
            .data
            .iter()
            .map(|row| {
                let mut row = row.clone();
                row.reverse();
                row
            })
            .collect();

        Tile { id: self.id, data }
    }

    fn vertical_flip(&self) -> Tile {
        let mut data = self.data.clone();
        data.reverse();

        Tile { id: self.id, data }
    }

    fn rotate(&self) -> Tile {
        let width = self.data.len();

        let mut data = vec![];
        for i in 0..width {
            data.push(vec!['.'; width]);
            for j in 0..width {
                data[i][j] = self.data[width - j - 1][i];
            }
        }

        Tile { id: self.id, data }
    }

    fn borders(&self) -> [Vec<char>; 4] {
        [
            self.data[0].clone(),
            self.rotate().data[0].clone(),
            {
                let mut border = self.rotate().rotate().data[0].clone();
                border.reverse();
                border
            },
            {
                let mut border = self.rotate().rotate().rotate().data[0].clone();
                border.reverse();
                border
            },
        ]
    }

    fn find_border(&self, other: &Tile, pos: (i32, i32)) -> Option<((i32, i32), Tile)> {
        if self.id == other.id {
            return None;
        }

        self.borders()
            .iter()
            .enumerate()
            .find_map(|(i, self_boarder)| {
                let new_pos = match i {
                    0 => (pos.0, pos.1 - 1),
                    1 => (pos.0 - 1, pos.1),
                    2 => (pos.0, pos.1 + 1),
                    _ => (pos.0 + 1, pos.1),
                };

                [
                    other.clone(),
                    other.rotate(),
                    other.rotate().rotate(),
                    other.rotate().rotate().rotate(),
                ]
                .iter()
                .find_map(|other| {
                    [
                        other.clone(),
                        other.vertical_flip(),
                        other.horizontal_flip(),
                    ]
                    .iter()
                    .find_map(|other| {
                        let boarder = other.borders()[(i + 2) % 4].clone();

                        if *self_boarder == boarder {
                            // println!("{} {:?} {:?}", i, pos, new_pos);
                            // println!("{:?}", self_boarder);
                            // println!("{:?}", boarder);
                            Some((new_pos, other.clone()))
                        } else {
                            None
                        }
                    })
                })
            })
    }

    fn remove_borders(&self) -> Tile {
        let mut data = self.data.clone();

        data.remove(0);
        data.pop();

        data.iter_mut().for_each(|row| {
            row.remove(0);
            row.pop();
        });

        Tile { id: self.id, data }
    }
}

fn _part1() {
    let tiles = _INPUT
        .split("\n\n")
        .map(|tile| {
            let mut lines = tile.lines();
            let id = lines
                .next()
                .unwrap()
                .split(' ')
                .nth(1)
                .unwrap()
                .strip_suffix(':')
                .unwrap()
                .parse()
                .unwrap();

            let data = lines.map(|line| line.chars().collect()).collect();

            Tile { id, data }
        })
        .collect::<Vec<_>>();

    // println!("{:?}", tiles[0].rotate().data)
    let mut map = HashMap::new();

    let insert = |source: &Tile, pos: (i32, i32)| -> Vec<_> {
        let mut ret = vec![];
        tiles.iter().for_each(|tile| {
            if let Some(r) = source.find_border(tile, pos) {
                // println!("source: {},\tpos: {:?},\tnew: {},\tpos: {:?}", source.id, pos, r.1.id, r.0);
                ret.push(r);
            }
        });
        ret
    };

    map.insert((0, 0), tiles[0].clone());
    let mut next = insert(&tiles[0], (0, 0));
    // let mut next = insert(&next[0].1, (-1, 0));
    // println!("{:?}", next.iter().map(|(a, b)| (a, b.id)).collect::<Vec<_>>());
    while !next.is_empty() {
        let mut new = vec![];
        // println!("{:?}", next.iter().map(|(a, b)| (a, b.id)).collect::<Vec<_>>());

        next.iter().for_each(|(pos, tile)| {
            if map.insert(*pos, tile.clone()).is_none() {
                new.append(&mut insert(tile, *pos));
            }
        });

        next = new;
    }

    let (left, top) = map.keys().fold((0, 0), |(x, y), (x2, y2)| {
        (cmp::min(x, *x2), cmp::min(y, *y2))
    });
    let (right, bot) = map.keys().fold((0, 0), |(x, y), (x2, y2)| {
        (cmp::max(x, *x2), cmp::max(y, *y2))
    });

    // println!("{} {} {} {}", top, bot, left, right);
    // println!("{:?}", map.keys().map(|(a, b)| (a, b)).collect::<Vec<_>>());

    let product = map.get(&(left, top)).unwrap().id
        * map.get(&(right, top)).unwrap().id
        * map.get(&(left, bot)).unwrap().id
        * map.get(&(right, bot)).unwrap().id;

    // tiles.clone().next().unwrap().rotate();
    println!("{:?}", product);

    let width = tiles[0].data.len();
    (top..=bot).into_iter().for_each(|y| {
        (0..width - 2).into_iter().for_each(|i| {
            (left..=right).into_iter().for_each(|x| {
                // println!("{} {}", x, y);
                print!(
                    "{}",
                    String::from_iter(map.get(&(x, y)).unwrap().remove_borders().data[i].clone())
                );
            });
            println!();
        });
    });
}

fn main() {
    let data = _MAP.lines().map(|line| line.chars().collect()).collect();
    let width = _MAP.lines().next().unwrap().len();

    let pos = _SNAKE
        .lines()
        .enumerate()
        .flat_map(|(i, line)| {
            line.chars()
                .enumerate()
                .filter(|(_, ch)| *ch == '#')
                .map(|(pos, _)| pos + i * width)
                .collect::<Vec<_>>()
        })
        .collect::<Vec<_>>();

    println!("{:?}", pos);

    let starts = (0..width - 2)
        .into_iter()
        .flat_map(|i| {
            (0..width - 20)
                .into_iter()
                .map(|j| i * width + j)
                .collect::<Vec<_>>()
        })
        .collect::<Vec<_>>();

    // println!("{:?}", starts);

    let map = Tile { id: 0, data };
    [
        map.clone(),
        map.rotate(),
        map.rotate().rotate(),
        map.rotate().rotate().rotate(),
    ]
    .iter()
    .any(|map| {
        [map.clone(), map.vertical_flip(), map.horizontal_flip()]
            .iter()
            .any(|map| {
                let ch = map.clone().data.into_iter().flatten().collect::<Vec<_>>();

                let count = starts
                    .iter()
                    .filter(|start| pos.iter().all(|pos| ch[*pos + *start] == '#'))
                    .count();

                if count != 0 {
                    println!("monsters: {}", count);
                    let map_count = ch.iter().filter(|ch| **ch == '#').count();
                    let monster_count = pos.len() * count;

                    println!("{}", map_count - monster_count);
                    return true;
                }

                false
            })
    });
}
